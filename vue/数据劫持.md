### Object

getter收集依赖

setter触发依赖

依赖保存在Dep 用于收集 删除 向依赖发送消息

收集依赖 收集Watcher（什么组件 使用该状态

![image-20220221234600413](C:\Users\pc\AppData\Roaming\Typora\typora-user-images\image-20220221234600413.png)

### 数组

原生方法`push pop shift unshift sort splice reverse`

修改原型方法 来触发依赖



```javascript
/*
function defineReactive (data,key,value){
    Object.defineProperty(data,key,{
        enumerable: true,
        configurable: true,
        get: function(){
            return value
        },
        set:function (newvalue) {  
            if(value === newvalue)
                return;
            value = newvalue
        }
    })
}
*/
/* 依赖保存地 */
class Dep {
    constructor(){
        this.subs = [];
    }

    addSub(sub){
        this.subs.push(sub)
    }

    removeSub(sub){
        if(this.subs.length){
            const index = subs.indexOf(sub)
            if(index != -1)
                this.subs.splice(index,1)
        }
    }
    /**
     * 添加依赖
     */
    depend(){
        if(window.tartget)
            this.addSub(window,tartget)
    }
    /**
     * 触发依赖
     */
    notify(){
        for(let i = 0;i < this.subs.length;i++)
            subs[i].update()
    }
}

const data = {
    name: 'chuguo',
    f: {
        name: 'oder'
    },
    number: ['z','c','g','b']
}


/* 对象数据劫持 */
let methods = ['push','pop','unshift','shift','splice','sort','reserve']
let newArray = Array.prototype

methods.forEach( method => {
    newArray[method] = function () {
        // console.log('Array 触发',method)  
        newArray[method].apply(this,...arguments)
    }
})

/**
 * 转化成响应式 收集依赖 触发依赖
 * @param {object} tartget 
 * @param {key} key 
 * @param {value} value 
 */
function defineReactive(tartget,key,value){
    let dep = new Dep() // 保存依赖位置
    observer(value)

    if(Array.isArray(tartget))
        tartget._proto_ = newArray

    Object.defineProperty(tartget,key,{
        get(){
            // console.log('get: '+tartget,key,value)
            /* 收集依赖 */
            dep.depend()
            return value
        },
        set(newvalue){
            if(newvalue === value)
                return;
            value = newvalue
            /* 触发依赖 */
            dep.notify()
            // console.log('set: '+tartget,key,value)
        }
    })
}
/**
 * 将对象所有数据转化成响应式 包括子数据
 * @param {object} tartget 
 * @returns 
 */
function observer(tartget) { 
    if(typeof tartget !== 'object' || typeof tartget === 'null')
        return tartget;
    for(let key in tartget)
        defineReactive(tartget,key,tartget[key])
}

```



